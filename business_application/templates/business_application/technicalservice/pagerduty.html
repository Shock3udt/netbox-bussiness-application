{% extends 'generic/object.html' %}
{% load helpers %}
{% load static %}
{% load l10n %}
{% load pagerduty_filters %}

{% block title %}{{ object.name }} - PagerDuty Integration{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="breadcrumb-item"><a href="{% url 'plugins:business_application:technicalservice_list' %}">Technical Services</a></li>
    <li class="breadcrumb-item"><a href="{{ object.get_absolute_url }}">{{ object.name }}</a></li>
    <li class="breadcrumb-item active">PagerDuty</li>
{% endblock %}

{% block content %}
<!-- PagerDuty Integration Status -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-shield-alert-outline"></i> PagerDuty Integration Status
                <div class="float-end">
                    {% if object.has_pagerduty_integration %}
                        <span class="badge bg-success">
                            <i class="mdi mdi-check-circle"></i> Configured
                        </span>
                    {% else %}
                        <span class="badge bg-warning">
                            <i class="mdi mdi-alert-outline"></i> Not Configured
                        </span>
                    {% endif %}
                </div>
            </h5>
            <div class="card-body">
                {% if object.has_pagerduty_integration %}
                    <div class="alert alert-success">
                        <i class="mdi mdi-check-circle me-2"></i>
                        This technical service is <strong>fully configured</strong> for PagerDuty integration with both service definition and router rule templates.
                    </div>
                {% elif object.pagerduty_service_definition or object.pagerduty_router_rule %}
                    <div class="alert alert-warning">
                        <i class="mdi mdi-alert-outline me-2"></i>
                        This technical service is <strong>partially configured</strong> for PagerDuty integration. Both service definition and router rule templates are required for complete integration.
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="mdi mdi-information-outline me-2"></i>
                        This technical service is not yet configured for PagerDuty integration. Assign both service definition and router rule templates to enable synchronization.
                    </div>
                {% endif %}

                <div class="row mt-3">
                    <!-- Routing Key Card -->
                    <div class="col-md-4">
                        <div class="card {% if object.pagerduty_routing_key %}border-success{% else %}border-secondary{% endif %}">
                            <h6 class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="mdi mdi-key"></i> Routing Key</span>
                                {% if object.pagerduty_routing_key %}
                                    <span class="badge bg-success"><i class="mdi mdi-check"></i> Own Key</span>
                                {% else %}
                                    <span class="badge bg-secondary"><i class="mdi mdi-key-chain"></i> Inherited</span>
                                {% endif %}
                            </h6>
                            <div class="card-body">
                                {% if object.pagerduty_routing_key %}
                                    <code class="text-success">{{ object.pagerduty_routing_key|mask_routing_key }}</code>
                                    <br><small class="text-muted">This service has its own routing key</small>
                                {% else %}
                                    <span class="text-muted">No own routing key</span>
                                    <br>
                                    {% with routing_info=object.get_pagerduty_routing_key_with_source %}
                                        {% if routing_info.0 %}
                                            <small class="text-info">
                                                <i class="mdi mdi-arrow-up"></i> Inherited: <code>{{ routing_info.0|mask_routing_key }}</code>
                                                <br>From: {{ routing_info.1 }}
                                            </small>
                                        {% else %}
                                            <small class="text-warning">
                                                <i class="mdi mdi-alert"></i> No routing key in hierarchy!
                                            </small>
                                        {% endif %}
                                    {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Service Definition Template Card -->
                    <div class="col-md-4">
                        <div class="card {% if object.pagerduty_service_definition %}border-success{% else %}border-warning{% endif %}">
                            <h6 class="card-header d-flex justify-content-between align-items-center">
                                Service Definition Template
                                {% if object.pagerduty_service_definition %}
                                    <span class="badge bg-success"><i class="mdi mdi-check"></i></span>
                                {% else %}
                                    <span class="badge bg-warning"><i class="mdi mdi-alert"></i></span>
                                {% endif %}
                            </h6>
                            <div class="card-body">
                                {% if object.pagerduty_service_definition %}
                                    <strong><a href="{{ object.pagerduty_service_definition.get_absolute_url }}">{{ object.pagerduty_service_definition.name }}</a></strong>
                                    <br><small class="text-muted">{{ object.pagerduty_service_definition.description|default:"No description" }}</small>
                                {% else %}
                                    <span class="text-muted">No service definition template assigned</span>
                                    <br><small class="text-warning">Required for PagerDuty integration</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Router Rule Template Card -->
                    <div class="col-md-4">
                        <div class="card {% if object.pagerduty_router_rule %}border-success{% else %}border-warning{% endif %}">
                            <h6 class="card-header d-flex justify-content-between align-items-center">
                                Router Rule Template
                                {% if object.pagerduty_router_rule %}
                                    <span class="badge bg-success"><i class="mdi mdi-check"></i></span>
                                {% else %}
                                    <span class="badge bg-warning"><i class="mdi mdi-alert"></i></span>
                                {% endif %}
                            </h6>
                            <div class="card-body">
                                {% if object.pagerduty_router_rule %}
                                    <strong><a href="{{ object.pagerduty_router_rule.get_absolute_url }}">{{ object.pagerduty_router_rule.name }}</a></strong>
                                    <br><small class="text-muted">{{ object.pagerduty_router_rule.description|default:"No description" }}</small>
                                {% else %}
                                    <span class="text-muted">No router rule template assigned</span>
                                    <br><small class="text-warning">Required for PagerDuty integration</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Routing Key Hierarchy -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-key-chain"></i> Routing Key Hierarchy
            </h5>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Routing keys are inherited from upstream (parent) services. The first routing key found in the hierarchy is used.
                </p>

                <!-- Current Service -->
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-primary me-2">Current</span>
                    <strong>{{ object.name }}</strong>
                    {% if object.pagerduty_routing_key %}
                        <code class="ms-2 text-success">{{ object.pagerduty_routing_key|mask_routing_key }}</code>
                        <span class="badge bg-success ms-2">âœ“ Has Key</span>
                    {% else %}
                        <span class="text-muted ms-2">No own key</span>
                    {% endif %}
                </div>

                <!-- Upstream Services -->
                {% if object.upstream_dependencies.exists %}
                    <div class="ms-4 border-start ps-3">
                        <small class="text-muted d-block mb-2"><i class="mdi mdi-arrow-up"></i> Upstream (Parent) Services:</small>
                        {% for dep in object.upstream_dependencies.all %}
                            <div class="d-flex align-items-center mb-1">
                                <i class="mdi mdi-circle-small text-muted"></i>
                                <a href="{{ dep.upstream_service.get_absolute_url }}">{{ dep.upstream_service.name }}</a>
                                {% if dep.upstream_service.pagerduty_routing_key %}
                                    <code class="ms-2 text-success">{{ dep.upstream_service.pagerduty_routing_key|mask_routing_key }}</code>
                                    <span class="badge bg-success ms-1">Has Key</span>
                                {% else %}
                                    <span class="text-muted ms-2 small">No key</span>
                                {% endif %}
                                <span class="badge bg-secondary ms-2">{{ dep.get_dependency_type_display }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="ms-4 text-muted">
                        <small><i class="mdi mdi-information-outline"></i> This is a root service (no upstream dependencies)</small>
                    </div>
                {% endif %}

                <!-- Business Applications -->
                {% if object.business_apps.exists %}
                    <div class="ms-4 border-start ps-3 mt-3">
                        <small class="text-muted d-block mb-2"><i class="mdi mdi-briefcase"></i> Business Applications (fallback):</small>
                        {% for app in object.business_apps.all %}
                            <div class="d-flex align-items-center mb-1">
                                <i class="mdi mdi-circle-small text-muted"></i>
                                <a href="{{ app.get_absolute_url }}">{{ app.name }}</a>
                                {% if app.pagerduty_routing_key %}
                                    <code class="ms-2 text-info">{{ app.pagerduty_routing_key|mask_routing_key }}</code>
                                    <span class="badge bg-info ms-1">Has Key</span>
                                {% else %}
                                    <span class="text-muted ms-2 small">No key</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Effective Routing Key Summary -->
                {% with routing_info=object.get_pagerduty_routing_key_with_source %}
                <div class="alert {% if routing_info.0 %}alert-success{% else %}alert-warning{% endif %} mt-3 mb-0">
                    {% if routing_info.0 %}
                        <i class="mdi mdi-check-circle me-2"></i>
                        <strong>Effective Routing Key:</strong>
                        <code>{{ routing_info.0|mask_routing_key }}</code>
                        <br>
                        <small>Source: {{ routing_info.1 }}</small>
                    {% else %}
                        <i class="mdi mdi-alert me-2"></i>
                        <strong>No Routing Key Available!</strong>
                        <br>
                        <small>PagerDuty incidents cannot be created for this service. Configure a routing key on this service or an upstream service.</small>
                    {% endif %}
                </div>
                {% endwith %}
            </div>
        </div>
    </div>
</div>

<!-- PagerDuty Configuration -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-cogs"></i> PagerDuty Configuration
                <div class="float-end">
                    {% if perms.business_application.change_technicalservice %}
                        <a href="{% url 'plugins:business_application:technicalservice_pagerduty_edit' object.pk %}" class="btn btn-sm btn-primary">
                            <i class="mdi mdi-pencil"></i> Edit
                        </a>
                    {% endif %}
                    {% if object.pagerduty_service_definition %}
                        <a href="{{ object.pagerduty_service_definition.get_absolute_url }}" class="btn btn-sm btn-outline-secondary">
                            <i class="mdi mdi-file-document-outline"></i> View Service Template
                        </a>
                    {% endif %}
                    {% if object.pagerduty_router_rule %}
                        <a href="{{ object.pagerduty_router_rule.get_absolute_url }}" class="btn btn-sm btn-outline-secondary">
                            <i class="mdi mdi-file-document-outline"></i> View Router Template
                        </a>
                    {% endif %}
                    {% if object.has_pagerduty_integration %}
                        <button class="btn btn-sm btn-outline-secondary" onclick="validatePagerDutyConfig()">
                            <i class="mdi mdi-check-decagram"></i> Validate
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportPagerDutyConfig()">
                            <i class="mdi mdi-download"></i> Export JSON
                        </button>
                    {% endif %}
                </div>
            </h5>
            <div class="card-body">
                {% if object.has_pagerduty_integration %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="mdi mdi-information-outline"></i> Service Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>{{ object.pagerduty_config.name|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Description:</strong></td>
                                    <td>{{ object.pagerduty_config.description|default:"Not specified" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td>
                                        {% if object.pagerduty_config.status == 'active' %}
                                            <span class="badge bg-success">{{ object.pagerduty_config.status|title }}</span>
                                        {% else %}
                                            <span class="badge bg-warning">{{ object.pagerduty_config.status|title }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="mdi mdi-escalator-up"></i> Escalation Policy</h6>
                            {% if object.pagerduty_config.escalation_policy %}
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Policy ID:</strong></td>
                                        <td><code>{{ object.pagerduty_config.escalation_policy.id }}</code></td>
                                    </tr>
                                </table>
                            {% else %}
                                <p class="text-muted">No escalation policy configured</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Raw Configuration -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h6><i class="mdi mdi-code-json"></i> Raw Configuration</h6>
                            <div class="card bg-light">
                                <div class="card-body p-2">
                                    <pre id="pagerduty-config-json" class="mb-0" style="max-height: 300px; overflow-y: auto; font-size: 0.875em;">{{ object.pagerduty_config|safe }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>

                {% else %}
                    <div class="text-center py-5">
                        <i class="mdi mdi-shield-alert-outline text-muted" style="font-size: 4rem;"></i>
                        <h5 class="text-muted mt-3">No PagerDuty Configuration</h5>
                        <p class="text-muted">
                            Add PagerDuty configuration to enable integration and synchronization with PagerDuty services.
                        </p>
                        {% if perms.business_application.change_technicalservice %}
                            <a href="{% url 'plugins:business_application:technicalservice_pagerduty_edit' object.pk %}" class="btn btn-primary">
                                <i class="mdi mdi-plus"></i> Add Configuration
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Validation Results -->
<div id="validation-results"></div>
{% endblock %}

{% block javascript %}
{{ block.super }}

{% if object.pagerduty_config %}
    {{ object.pagerduty_config|json_script:"pagerduty-config-data" }}
{% endif %}

<script>
window.pagerDutyConfig = null;
{% if object.pagerduty_config %}
try {
    const configElement = document.getElementById('pagerduty-config-data');
    if (configElement) {
        window.pagerDutyConfig = JSON.parse(configElement.textContent);
    }
} catch (e) {
    console.error('Error parsing PagerDuty config:', e);
}
{% endif %}

function validatePagerDutyConfig() {
    const resultsDiv = document.getElementById('validation-results');
    resultsDiv.innerHTML = '<div class="alert alert-info"><i class="mdi mdi-loading mdi-spin"></i> Validating...</div>';

    setTimeout(() => {
        let errors = [];
        if (window.pagerDutyConfig) {
            if (!window.pagerDutyConfig.name) errors.push('Service name is required');
            if (!window.pagerDutyConfig.escalation_policy?.id) errors.push('Escalation policy ID is required');
        } else {
            errors = ['No PagerDuty configuration found'];
        }

        if (errors.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-success"><i class="mdi mdi-check-circle"></i> Validation successful!</div>';
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger"><i class="mdi mdi-alert-circle"></i> Errors: ' + errors.join(', ') + '</div>';
        }
        setTimeout(() => { resultsDiv.innerHTML = ''; }, 5000);
    }, 1000);
}

function exportPagerDutyConfig() {
    if (window.pagerDutyConfig) {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.pagerDutyConfig, null, 2));
        const a = document.createElement('a');
        a.href = dataStr;
        a.download = "{{ object.name|slugify }}_pagerduty.json";
        a.click();
    } else {
        alert('No configuration to export');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const configElement = document.getElementById('pagerduty-config-json');
    if (configElement && window.pagerDutyConfig) {
        configElement.textContent = JSON.stringify(window.pagerDutyConfig, null, 2);
    }
});
</script>
{% endblock %}