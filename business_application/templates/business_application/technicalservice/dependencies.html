{% extends 'generic/object.html' %}
{% load helpers %}
{% load render_table from django_tables2 %}
{% load static %}

{% block title %}{{ object.name }} - Dependencies{% endblock %}

{% block breadcrumbs %}
    {{ block.super }}
    <li class="breadcrumb-item"><a href="{% url 'plugins:business_application:technicalservice_list' %}">Technical Services</a></li>
    <li class="breadcrumb-item"><a href="{{ object.get_absolute_url }}">{{ object.name }}</a></li>
    <li class="breadcrumb-item active">Dependencies</li>
{% endblock %}

{% block content %}
<!-- Dependency Graph Visualization -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-graph-outline"></i> Dependency Graph
                <div class="float-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="resetGraph()">
                        <i class="mdi mdi-refresh"></i> Reset View
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="exportGraph()">
                        <i class="mdi mdi-download"></i> Export SVG
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="togglePhysics()">
                        <i class="mdi mdi-play-pause"></i> Toggle Physics
                    </button>
                </div>
            </h5>
            <div class="card-body">
                <div id="dependency-graph" style="width: 100%; height: 600px; border: 1px solid #dee2e6; border-radius: 6px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading dependency graph...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="mdi mdi-information"></i>
                        <strong>Legend:</strong>
                        <span class="badge bg-primary ms-1">Current Service (Blue Border)</span>
                        <span class="badge bg-success ms-1">Healthy</span>
                        <span class="badge bg-warning ms-1">Degraded</span>
                        <span class="badge bg-danger ms-1">Down</span>
                        <span class="badge bg-info ms-1">Under Maintenance</span>
                        <span class="badge bg-warning ms-1">Redundancy Group</span>
                        • <span style="color: #007bff; font-weight: bold;">—</span> Normal Dependency
                        • <span style="color: #28a745; font-weight: bold;">- - -</span> Redundancy Group
                        <br>
                        <i class="mdi mdi-hand-pointing-up"></i> <em>Drag nodes to reposition, scroll to zoom, click nodes to navigate</em>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dependency Management Section -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-cogs"></i> Dependency Management
                <div class="float-end">
                    <a href="{% url 'plugins:business_application:servicedependency_add' %}?upstream_service={{ object.id }}" class="btn btn-sm btn-primary">
                        <i class="mdi mdi-plus"></i> Add Upstream Dependency
                    </a>
                    <a href="{% url 'plugins:business_application:servicedependency_add' %}?downstream_service={{ object.id }}" class="btn btn-sm btn-success">
                        <i class="mdi mdi-plus"></i> Add Downstream Dependency
                    </a>
                </div>
            </h5>
        </div>
    </div>
</div>

<!-- Upstream Dependencies -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-arrow-up-circle"></i> Upstream Dependencies
                <small class="text-muted">({{ object.get_upstream_dependencies.count }})</small>
            </h5>
            <div class="card-body">
                {% if upstream_dependencies_table.data %}
                    {% render_table upstream_dependencies_table %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="mdi mdi-information-outline"></i>
                        No upstream dependencies configured
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Downstream Dependencies -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-arrow-down-circle"></i> Downstream Dependencies
                <small class="text-muted">({{ object.get_downstream_dependencies.count }})</small>
            </h5>
            <div class="card-body">
                {% if downstream_dependencies_table.data %}
                    {% render_table downstream_dependencies_table %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="mdi mdi-information-outline"></i>
                        No downstream dependencies configured
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Affected Business Applications -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <h5 class="card-header">
                <i class="mdi mdi-domain"></i> Affected Business Applications
                <small class="text-muted">({{ object.get_downstream_business_applications.count }})</small>
            </h5>
            <div class="card-body">
                {% if downstream_business_applications_table.data %}
                    {% render_table downstream_business_applications_table %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="mdi mdi-information-outline"></i>
                        No business applications would be affected by this service
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}

<!-- Load HTMX as fallback if not available from js_lib_htmx -->
<script>
// Check if htmx is available, if not load it from CDN
if (typeof htmx === 'undefined') {
    var script = document.createElement('script');
    script.src = 'https://unpkg.com/htmx.org@1.9.12';
    script.onload = function() {
        console.log('HTMX loaded from CDN as fallback');
    };
    document.head.appendChild(script);
}
</script>

<!-- D3.js Library -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graph configuration
    const width = document.getElementById('dependency-graph').offsetWidth;
    const height = 600;
    let simulation;
    let physicsEnabled = true;

    // Color scheme
    const colors = {
        healthyService: '#28a745',      // Green
        degradedService: '#ffc107',     // Yellow/Orange
        downService: '#dc3545',         // Red
        maintenanceService: '#17a2b8',  // Blue
        redundancyGroup: '#fd7e14',     // Orange
        normalLink: '#007bff',          // Blue
        redundancyLink: '#28a745',      // Green
        currentServiceBorder: '#007bff' // Blue border for current service
    };

    // Create SVG element
    const svg = d3.select('#dependency-graph')
        .html('')  // Clear loading spinner
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    // Create zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', function(event) {
            container.attr('transform', event.transform);
        });

    svg.call(zoom);

    // Container for graph elements
    const container = svg.append('g');

    // Create arrow markers for dependencies
    const defs = svg.append('defs');

    // Create gradient for background
    const gradient = defs.append('linearGradient')
        .attr('id', 'bg-gradient')
        .attr('gradientUnits', 'userSpaceOnUse')
        .attr('x1', 0).attr('y1', 0)
        .attr('x2', width).attr('y2', height);

    gradient.append('stop')
        .attr('offset', '0%')
        .attr('stop-color', '#f8f9fa');

    gradient.append('stop')
        .attr('offset', '100%')
        .attr('stop-color', '#e9ecef');

    // Normal dependency arrow
    defs.append('marker')
        .attr('id', 'arrow-normal')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 25)
        .attr('refY', 0)
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', colors.normalLink);

    // Redundancy dependency arrow
    defs.append('marker')
        .attr('id', 'arrow-redundancy')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 25)
        .attr('refY', 0)
        .attr('markerWidth', 8)
        .attr('markerHeight', 8)
        .attr('orient', 'auto')
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', colors.redundancyLink);

    // Fetch dependency data from API
    fetch(`{% url 'plugins:business_application:technicalservice_dependencies_api' object.id %}`)
        .then(response => response.json())
        .then(data => {
            renderGraph(data);
        })
        .catch(error => {
            console.error('Error fetching dependency data:', error);
            d3.select('#dependency-graph').html('<div class="alert alert-warning m-3">Error loading dependency graph. Please check the console for details.</div>');
        });

    function renderGraph(data) {
        // Clear existing elements
        container.selectAll('*').remove();

        if (!data.nodes || data.nodes.length === 0) {
            d3.select('#dependency-graph').html('<div class="alert alert-info m-3"><i class="mdi mdi-information-outline me-2"></i>No dependency relationships to display.</div>');
            return;
        }

        // Process redundant dependencies to create groups
        const processedData = processRedundantDependencies(data);

        // Create force simulation
        simulation = d3.forceSimulation(processedData.nodes)
            .force('link', d3.forceLink(processedData.links).id(d => d.id).distance(120))
            .force('charge', d3.forceManyBody().strength(-400))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(d => getNodeRadius(d) + 10))
            .force('x', d3.forceX().strength(0.1))
            .force('y', d3.forceY().strength(0.1));

        // Create links
        const link = container.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(processedData.links)
            .enter()
            .append('line')
            .attr('stroke', d => d.type === 'normal' ? colors.normalLink : colors.redundancyLink)
            .attr('stroke-width', 3)
            .attr('stroke-dasharray', d => d.type === 'normal' ? '0' : '10,5')
            .attr('marker-end', d => d.type === 'normal' ? 'url(#arrow-normal)' : 'url(#arrow-redundancy)')
            .attr('opacity', 0.8);

        // Create nodes
        const node = container.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(processedData.nodes)
            .enter()
            .append('g')
            .attr('class', 'node')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // Add circles for nodes
        node.append('circle')
            .attr('r', d => getNodeRadius(d))
            .attr('fill', d => getNodeColor(d))
            .attr('stroke', d => d.id === {{ object.id }} ? colors.currentServiceBorder : '#ffffff')
            .attr('stroke-width', d => d.id === {{ object.id }} ? 5 : 3)
            .attr('filter', 'drop-shadow(2px 2px 4px rgba(0,0,0,0.3))')
            .style('cursor', 'pointer');

        // Add additional blue highlight circle for current service
        node.filter(d => d.id === {{ object.id }})
            .append('circle')
            .attr('r', d => getNodeRadius(d) + 8)
            .attr('fill', 'none')
            .attr('stroke', colors.currentServiceBorder)
            .attr('stroke-width', 3)
            .attr('stroke-dasharray', '5,3')
            .attr('opacity', 0.8)
            .style('pointer-events', 'none');

        // Add icons for redundancy group nodes
        node.filter(d => d.node_type === 'redundancy_group')
            .append('text')
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .style('font-family', 'Material Design Icons')
            .style('font-size', '16px')
            .style('fill', '#ffffff')
            .style('pointer-events', 'none')
            .text('󰔉');  // redundancy icon

        // Add labels for nodes
        node.append('text')
            .attr('dy', d => getNodeRadius(d) + 20)
            .attr('text-anchor', 'middle')
            .style('font-size', '12px')
            .style('font-weight', 'bold')
            .style('fill', '#333')
            .style('text-shadow', '1px 1px 2px rgba(255,255,255,0.8)')
            .style('pointer-events', 'none')
            .text(d => truncateText(d.name, 20));

        // Add service type badges
        node.filter(d => d.node_type === 'service')
            .append('text')
            .attr('dy', d => getNodeRadius(d) + 35)
            .attr('text-anchor', 'middle')
            .style('font-size', '10px')
            .style('fill', '#666')
            .style('pointer-events', 'none')
            .text(d => d.service_type === 'technical' ? 'Tech' : d.service_type === 'logical' ? 'Logic' : 'Svc');

        // Add tooltips
        node.append('title')
            .text(d => {
                if (d.node_type === 'redundancy_group') {
                    return `${d.name}\nRedundancy Group\nServices in this group: ${d.service_count}\nFailure only occurs if ALL services fail`;
                } else {
                    const healthLabel = d.health_status.replace('_', ' ').toUpperCase();
                    return `${d.name}\nType: ${d.service_type}\nHealth: ${healthLabel}\nUpstream: ${d.upstream_count || 0}\nDownstream: ${d.downstream_count || 0}`;
                }
            });

        // Add link labels
        const linkLabels = container.append('g')
            .attr('class', 'link-labels')
            .selectAll('text')
            .data(processedData.links)
            .enter()
            .append('text')
            .attr('font-size', '10px')
            .attr('fill', '#666')
            .attr('text-anchor', 'middle')
            .style('pointer-events', 'none')
            .text(d => d.name ? truncateText(d.name, 15) : '');

        // Update positions on simulation tick
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node
                .attr('transform', d => `translate(${d.x},${d.y})`);

            linkLabels
                .attr('x', d => (d.source.x + d.target.x) / 2)
                .attr('y', d => (d.source.y + d.target.y) / 2);
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active && physicsEnabled) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active && physicsEnabled) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Add click handler for nodes
        node.on('click', function(event, d) {
            if (d.node_type === 'service' && d.id !== {{ object.id }}) {
                window.location.href = d.url;
            } else if (d.node_type === 'redundancy_group' && d.url) {
                window.location.href = d.url;
            }
        });

        // Add hover effects
        node.on('mouseover', function(event, d) {
            const nodeElement = d3.select(this);

            // Animate main circle
            nodeElement.select('circle')
                .transition()
                .duration(200)
                .attr('r', getNodeRadius(d) + 5)
                .attr('stroke-width', d.id === {{ object.id }} ? 6 : 4);

            // Animate blue highlight circle for current service
            if (d.id === {{ object.id }}) {
                nodeElement.selectAll('circle:nth-child(2)')
                    .transition()
                    .duration(200)
                    .attr('r', getNodeRadius(d) + 13)
                    .attr('stroke-width', 4);
            }
        })
        .on('mouseout', function(event, d) {
            const nodeElement = d3.select(this);

            // Reset main circle
            nodeElement.select('circle')
                .transition()
                .duration(200)
                .attr('r', getNodeRadius(d))
                .attr('stroke-width', d.id === {{ object.id }} ? 5 : 3);

            // Reset blue highlight circle for current service
            if (d.id === {{ object.id }}) {
                nodeElement.selectAll('circle:nth-child(2)')
                    .transition()
                    .duration(200)
                    .attr('r', getNodeRadius(d) + 8)
                    .attr('stroke-width', 3);
            }
        });
    }

    // Process redundant dependencies to create groups
    function processRedundantDependencies(data) {
        const nodes = [...data.nodes];
        const links = [];
        const redundancyGroups = new Map();

        // Group redundant dependencies by downstream service and dependency name/type
        data.links.forEach(link => {
            if (link.type === 'redundancy') {
                const groupKey = `${link.target}_${link.name || 'redundant'}`;

                if (!redundancyGroups.has(groupKey)) {
                    redundancyGroups.set(groupKey, {
                        id: `redundancy_${groupKey}`,
                        name: link.name || 'Redundant Group',
                        node_type: 'redundancy_group',
                        target: link.target,
                        sources: [],
                        service_count: 0
                    });
                }

                redundancyGroups.get(groupKey).sources.push(link.source);
                redundancyGroups.get(groupKey).service_count++;
            } else {
                // Normal dependencies pass through unchanged
                links.push(link);
            }
        });

        // Create redundancy group nodes and links
        redundancyGroups.forEach(group => {
            // Add the redundancy group node
            nodes.push({
                id: group.id,
                name: group.name,
                node_type: 'redundancy_group',
                service_count: group.service_count,
                url: null // No direct URL for groups
            });

            // Create links from each source service to the redundancy group
            group.sources.forEach(sourceId => {
                links.push({
                    source: sourceId,
                    target: group.id,
                    type: 'redundancy',
                    name: ''
                });
            });

            // Create link from redundancy group to target service
            links.push({
                source: group.id,
                target: group.target,
                type: 'redundancy',
                name: group.name
            });
        });

        return { nodes, links };
    }

    // Helper functions
    function getNodeRadius(d) {
        if (d.node_type === 'redundancy_group') return 18;
        return 25;
    }

    function getNodeColor(d) {
        if (d.node_type === 'redundancy_group') return colors.redundancyGroup;

        // Color based on health status (applies to all services including current)
        switch(d.health_status) {
            case 'down':
                return colors.downService;
            case 'degraded':
                return colors.degradedService;
            case 'under_maintenance':
                return colors.maintenanceService;
            case 'healthy':
                return colors.healthyService;
            default:
                return colors.healthyService;
        }
    }

    function truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
    }

    // Global functions for buttons
    window.resetGraph = function() {
        svg.transition().duration(750).call(
            zoom.transform,
            d3.zoomIdentity
        );
    };

    window.exportGraph = function() {
        const svgData = new XMLSerializer().serializeToString(svg.node());
        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
        const svgUrl = URL.createObjectURL(svgBlob);
        const downloadLink = document.createElement('a');
        downloadLink.href = svgUrl;
        downloadLink.download = '{{ object.name }}_dependency_graph.svg';
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(svgUrl);
    };

    window.togglePhysics = function() {
        physicsEnabled = !physicsEnabled;
        if (physicsEnabled) {
            simulation.alpha(0.3).restart();
        } else {
            simulation.stop();
        }
    };
});
</script>
{% endblock %}